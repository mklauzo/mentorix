version: "3.9"

# SaaS variant: Qdrant vector DB + PgBouncer connection pooling
# Usage: docker compose -f docker-compose.yml -f docker-compose.saas.yml up -d

networks:
  mentorix_proxy:
    driver: bridge
  mentorix_internal:
    driver: bridge
    internal: true

volumes:
  qdrant_data:
  pgbouncer_data:

services:
  # Override backend to use Qdrant
  backend:
    environment:
      - VECTOR_DB_BACKEND=qdrant
      - QDRANT_URL=http://qdrant:6333
      - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@pgbouncer:5432/${POSTGRES_DB}

  worker:
    environment:
      - VECTOR_DB_BACKEND=qdrant
      - QDRANT_URL=http://qdrant:6333
      - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@pgbouncer:5432/${POSTGRES_DB}

  # ── Qdrant Vector DB ──────────────────────────────────────
  qdrant:
    image: qdrant/qdrant:v1.11.0
    restart: unless-stopped
    networks:
      - mentorix_internal
    volumes:
      - qdrant_data:/qdrant/storage
    security_opt:
      - no-new-privileges:true
    # No ports exposed

  # ── PgBouncer Connection Pooler ───────────────────────────
  pgbouncer:
    image: edoburu/pgbouncer:1.23.1
    restart: unless-stopped
    networks:
      - mentorix_internal
    environment:
      - DB_HOST=${POSTGRES_HOST:-db}
      - DB_PORT=${POSTGRES_PORT:-5432}
      - DB_USER=${POSTGRES_USER}
      - DB_PASSWORD=${POSTGRES_PASSWORD}
      - DB_NAME=${POSTGRES_DB}
      - POOL_MODE=transaction
      - MAX_CLIENT_CONN=200
      - DEFAULT_POOL_SIZE=20
    security_opt:
      - no-new-privileges:true

  # ── Celery Flower (worker monitoring) ─────────────────────
  flower:
    image: mher/flower:2.0
    restart: unless-stopped
    networks:
      - mentorix_proxy
      - mentorix_internal
    environment:
      - CELERY_BROKER_URL=${CELERY_BROKER_URL}
      - FLOWER_BASIC_AUTH=${TRAEFIK_DASHBOARD_USER}:${GRAFANA_ADMIN_PASSWORD}
    security_opt:
      - no-new-privileges:true
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=mentorix_proxy"
      - "traefik.http.routers.flower.rule=Host(`${DOMAIN}`) && PathPrefix(`/flower`)"
      - "traefik.http.routers.flower.entrypoints=websecure"
      - "traefik.http.routers.flower.tls.certresolver=letsencrypt"
      - "traefik.http.services.flower.loadbalancer.server.port=5555"
